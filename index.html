<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <!-- 字符编码 -->
    <meta charset="UTF-8">

    <!-- 视口设置，用于响应式设计 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- 浏览器兼容性 -->
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <!-- 图片缓存控制 -->
    <meta http-equiv="Cache-Control" content="public, max-age=31536000">
    <meta http-equiv="Expires" content="31536000">

    <!-- 网站标题 -->
    <title>BlockHaity的主页</title>

    <!-- 引入CSS文件 -->
    <link rel="stylesheet" href="/style.css">

    <!-- 引入marked.js用于解析Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link rel="icon" href="/img/favicon.jpg">
</head>

<body>
    <div class="waterfall" id="waterfall">
        <!-- 瀑布流卡片将通过JavaScript动态生成 -->
    </div>

    <!-- 侧边栏卡片 -->
    <div class="sidebar-card">
        <div class="container">
            <img src="/img/favicon.jpg" alt="BlockHaity" class="avatar">
            <h2 style="text-align: center;"><b>BlockHaity</b></h2>
            <p style="text-align: center;">一个坐牢高中牲</p>
            <!-- 链接 -->
            <div class="link">
                <a href="https://github.com/BlockHaity">
                    <svg width="20" height="20" viewBox="0 0 1024 1024" fill="white" style="vertical-align: middle;">
                        <path
                            d="M512 42.666667A464.64 464.64 0 0 0 42.666667 502.186667 460.373333 460.373333 0 0 0 363.52 938.666667c23.466667 4.266667 32-9.813333 32-22.186667v-78.08c-130.56 27.733333-158.293333-61.44-158.293333-61.44a122.026667 122.026667 0 0 0-52.053334-67.413333c-42.666667-28.16 3.413333-27.733333 3.413334-27.733334a98.56 98.56 0 0 1 71.68 47.36 101.12 101.12 0 0 0 136.533333 37.973334 99.413333 99.413333 0 0 1 29.866667-61.44c-104.106667-11.52-213.333333-50.773333-213.333334-226.986667a177.066667 177.066667 0 0 1 47.36-124.16 161.28 161.28 0 0 1 4.693334-122.026666s39.68-12.8 128 46.933333a455.68 455.68 0 0 1 234.666666 0c89.6-59.733333 128-46.933333 128-46.933333a161.28 161.28 0 0 1 4.693334 122.026666 177.066667 177.066667 0 0 1 47.36 124.16c0 176.64-110.08 215.466667-213.333334 226.986667a106.666667 106.666667 0 0 1 32 85.333333v125.866667c0 14.933333 8.533333 26.88 32 22.186666A460.8 460.8 0 0 0 981.333333 502.186667 464.64 464.64 0 0 0 512 42.666667" />
                    </svg>
                    <span style="font-size: 15px; vertical-align: middle;">GitHub</span>
                </a>
            </div>
            <div class="link">
                <a href="https://bas.blockhaity.qzz.io">
                    <svg width="20" height="20" viewBox="0 0 1024 1024" fill="white" style="vertical-align: middle;">
                        <path
                            d="M832 64H192c-17.7 0-32 14.3-32 32v832c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V96c0-17.7-14.3-32-32-32zm-600 72h560v208H232V136zm560 480H232V408h560v208zm0 272H232V688h560v200zM304 240a40 40 0 1 0 80 0 40 40 0 1 0-80 0zm0 272a40 40 0 1 0 80 0 40 40 0 1 0-80 0zm0 272a40 40 0 1 0 80 0 40 40 0 1 0-80 0z" />
                    </svg>
                    <span style="font-size: 15px; vertical-align: middle;">个人博客</span>
                </a>
            </div>
            <div class="link">
                <a href="https://api.blockhaity.qzz.io/docs">
                    <svg width="20" height="20" viewBox="0 0 1024 1024" fill="white" style="vertical-align: middle;">
                        <path
                            d="M832 64H192c-17.7 0-32 14.3-32 32v832c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V96c0-17.7-14.3-32-32-32zM696 768H328c-4.4 0-8-3.6-8-8v-56c0-4.4 3.6-8 8-8h368c4.4 0 8 3.6 8 8v56c0 4.4-3.6 8-8 8zm0-176H328c-4.4 0-8-3.6-8-8v-56c0-4.4 3.6-8 8-8h368c4.4 0 8 3.6 8 8v56c0 4.4-3.6 8-8 8zm0-176H328c-4.4 0-8-3.6-8-8v-56c0-4.4 3.6-8 8-8h368c4.4 0 8 3.6 8 8v56c0 4.4-3.6 8-8 8z" />
                    </svg>
                    <span style="font-size: 15px; vertical-align: middle;">API</span>
                </a>
            </div>
        </div>
    </div>

    <script>
        // 获取瀑布流容器
        const waterfall = document.getElementById('waterfall');

        // 解析YAML front matter
        function parseFrontMatter(content) {
            const frontMatterRegex = /^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/;
            const match = content.match(frontMatterRegex);

            if (match) {
                const frontMatter = match[1];
                const markdownContent = match[2];

                // 解析简单的YAML属性
                const properties = {};
                frontMatter.split('\n').forEach(line => {
                    const [key, value] = line.split(':').map(part => part.trim());
                    if (key && value) {
                        properties[key] = value;
                    }
                });

                return {
                    properties,
                    content: markdownContent
                };
            }

            // 如果没有front matter，返回原始内容
            return {
                properties: {},
                content: content
            };
        }

        // 从服务器获取Markdown文件列表
        async function loadMarkdownFiles() {
            try {
                console.log('开始加载Markdown文件...');

                // 修改API端点为 root.json
                const response = await fetch('/markdown/root.json');

                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态: ${response.status}`);
                }

                const fileMap = await response.json();
                console.log('获取到的文件映射:', fileMap);

                if (!fileMap || Object.keys(fileMap).length === 0) {
                    console.warn('没有找到Markdown文件');
                    waterfall.innerHTML = '<div class="waterfall-card"><div class="waterfall-card-content"><p>暂无内容</p></div></div>';
                    return;
                }

                // 遍历文件映射对象
                for (const [title, filePath] of Object.entries(fileMap)) {
                    try {
                        console.log(`正在加载文件: ${title} -> ${filePath}`);
                        const fileResponse = await fetch(filePath);

                        if (!fileResponse.ok) {
                            console.warn(`文件 ${filePath} 加载失败: ${fileResponse.status}`);
                            continue;
                        }

                        const rawContent = await fileResponse.text();
                        console.log(`文件 ${title} 内容长度:`, rawContent.length);

                        // 解析front matter和内容
                        const { properties, content } = parseFrontMatter(rawContent);
                        console.log(`解析到的属性:`, properties);

                        // 创建瀑布流卡片，使用title作为卡片标题
                        const card = document.createElement('div');
                        card.className = 'waterfall-card';

                        // 应用front matter中的width属性
                        if (properties.width) {
                            if (properties.width === 'auto') {
                                card.style.width = 'auto';
                            } else if (properties.width === 'full') {
                                card.style.width = '100%';
                            } else {
                                card.style.width = properties.width;
                            }
                        }

                        // 设置卡片内容
                        card.innerHTML = `
                        <div class="waterfall-card-content">
                            <h3>${title}</h3>
                            ${marked.parse(content)}
                        </div>
                    `;

                        // 将卡片添加到瀑布流容器
                        waterfall.appendChild(card);

                    } catch (fileError) {
                        console.error(`加载文件 ${title} 失败:`, fileError);
                    }
                }

                // 检查是否成功创建了卡片
                const cards = document.querySelectorAll('.waterfall-card');
                console.log(`成功创建了 ${cards.length} 个卡片`);

            } catch (error) {
                console.error('加载Markdown文件失败:', error);
                // 显示错误信息
                waterfall.innerHTML = `
                <div class="waterfall-card">
                    <div class="waterfall-card-content">
                        <h3>加载失败</h3>
                        <p>无法加载内容，请稍后重试。</p>
                        <p>错误信息: ${error.message}</p>
                    </div>
                </div>
            `;
            }
        }

        // 页面加载完成后加载Markdown文件
        window.addEventListener('DOMContentLoaded', loadMarkdownFiles);
    </script>
</body>

</html>